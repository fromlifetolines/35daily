<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>嬰幼兒友善地圖（Demo）</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Noto Sans,"Helvetica Neue",Arial; margin: 0; padding: 16px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .toolbar { display: grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap: 8px; align-items: end; }
    .toolbar label { font-size: 12px; color: #555; }
    .toolbar select,.toolbar input { width: 100%; padding: 6px 8px; font-size: 14px; }
    .toolbar button { padding: 8px 10px; font-size: 14px; cursor: pointer; }
    .filter-indicators { margin: 10px 0 14px; display:flex; flex-wrap: wrap; gap: 10px; font-size: 14px; }
    #results { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
    .result-item { border: 1px solid #eee; border-radius: 10px; padding: 12px; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,.03); }
    .result-item h3 { margin: 0 0 6px; font-size: 16px; }
    .location-category, .features, .source-link { margin: 6px 0; font-size: 13px; color: #444; }
    .list-view { display: block !important; }
    .list-view .result-item { display: grid; grid-template-columns: 1.5fr 1fr 1fr 90px; gap: 8px; align-items: center; }
    .list-view .result-item h3 { margin:0; }
    .affiliate-section { margin-top: 16px; font-size: 14px; }
    .muted { color:#666; font-size:12px; }
  </style>
</head>
<body>
  <h1>嬰幼兒友善地點（範例資料）</h1>
  <div class="toolbar">
    <div>
      <label for="regionSelect">區域</label>
      <select id="regionSelect"></select>
    </div>
    <div>
      <label for="citySelect">縣市</label>
      <select id="citySelect"></select>
    </div>
    <div>
      <label for="categorySelect">類別</label>
      <select id="categorySelect"></select>
    </div>
    <div>
      <label for="keywordInput">關鍵字</label>
      <input type="text" id="keywordInput" placeholder="輸入地點或類別">
    </div>
    <div><button id="clearBtn">清除</button></div>
    <div><button id="toggleViewBtn">顯示清單</button></div>
  </div>
  <div class="filter-indicators">
    <label><input type="checkbox" class="indicator-chk" data-key="stroller">嬰兒車租借</label>
    <label><input type="checkbox" class="indicator-chk" data-key="nursing">哺乳室</label>
    <label><input type="checkbox" class="indicator-chk" data-key="diaper">尿布檯</label>
    <label><input type="checkbox" class="indicator-chk" data-key="hotwater">熱水提供</label>
    <label><input type="checkbox" class="indicator-chk" data-key="elevator">電梯</label>
    <label><input type="checkbox" class="indicator-chk" data-key="queue">排隊禮遇</label>
    <label><input type="checkbox" class="indicator-chk" data-key="play">遊戲區</label>
  </div>
  <div id="results">資料載入中…</div>
  <div class="affiliate-section">
    推薦資源（示例）：
    <a href="https://example.com/?utm_source=demo" target="_blank" rel="noopener">母嬰外出裝備合輯</a>
    <span class="muted">（可替換為你的短連結）</span>
  </div>

  <!-- Fallback data file -->
  <script src="./facilities-data.js"></script>
  <script>
  (function () {
    let facilities = [];
    let citiesByRegion = {};
    let allCities = [];
    let viewMode = "card";
    const resultsContainer = document.getElementById("results");

    init();

    async function init() {
      try {
        facilities = await loadFacilities();
        initializeFilters();
        updateResults();
      } catch (e) {
        console.error("資料載入失敗:", e);
        resultsContainer.textContent = "資料載入失敗。請確認 facilities.json 是否與 index.html 同層，或改用 facilities-data.js 備援。";
      }
    }

    async function loadFacilities() {
      try {
        const url = new URL("facilities.json", window.location.href);
        const resp = await fetch(url.toString(), { cache: "no-store" });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!Array.isArray(data)) throw new Error("資料格式錯誤");
        return data;
      } catch (err) {
        if (Array.isArray(window.FACILITIES_DATA)) {
          console.warn("使用備援資料 facilities-data.js：", err);
          return window.FACILITIES_DATA;
        }
        throw err;
      }
    }

    function initializeFilters() {
      const regionSelect = document.getElementById("regionSelect");
      const citySelect = document.getElementById("citySelect");
      const categorySelect = document.getElementById("categorySelect");

      citiesByRegion = {};
      const regions = new Set();
      const cities = new Set();
      const categories = new Set();

      facilities.forEach(item => {
        const ind = item.indicators || {};
        item.indicators = ind;
        regions.add(item.region || "");
        cities.add(item.city || "");
        categories.add(item.category || "");
        if (!citiesByRegion[item.region || ""]) {
          citiesByRegion[item.region || ""] = new Set();
        }
        citiesByRegion[item.region || ""].add(item.city || "");
      });

      const regionOrder = ["北部", "中部", "南部", "東部", "其他", "離島"];
      const regionList = Array.from(regions).filter(Boolean).sort((a,b)=>{
        const ai = regionOrder.indexOf(a), bi = regionOrder.indexOf(b);
        if (ai !== -1 || bi !== -1) return (ai === -1 ? 99 : ai) - (bi === -1 ? 99 : bi)
        return a.localeCompare(b)
      });

      regionSelect.innerHTML = "<option value=''>全部地區</option>";
      regionList.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        regionSelect.appendChild(opt);
      });

      allCities = Array.from(cities).filter(Boolean).sort((a,b)=> a.localeCompare(b));
      citySelect.innerHTML = "<option value=''>全部縣市</option>";
      allCities.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        citySelect.appendChild(opt);
      });

      const categoryList = Array.from(categories).filter(Boolean).sort((a,b)=> a.localeCompare(b));
      categorySelect.innerHTML = "<option value=''>全部類別</option>";
      categoryList.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });

      regionSelect.addEventListener("change", () => {
        populateCityOptions(regionSelect.value);
        updateResults();
      });
      citySelect.addEventListener("change", updateResults);
      categorySelect.addEventListener("change", updateResults);

      const keywordInput = document.getElementById("keywordInput");
      let debounceTimer;
      keywordInput.addEventListener("input", () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(updateResults, 150);
      });

      document.querySelectorAll(".indicator-chk").forEach(chk => {
        chk.addEventListener("change", updateResults);
      });

      document.getElementById("clearBtn").addEventListener("click", () => {
        regionSelect.value = "";
        populateCityOptions("");
        citySelect.value = "";
        categorySelect.value = "";
        keywordInput.value = "";
        document.querySelectorAll(".indicator-chk").forEach(chk => (chk.checked = false));
        viewMode = "card";
        document.getElementById("results").classList.remove("list-view");
        document.getElementById("toggleViewBtn").textContent = "顯示清單";
        updateResults();
      });

      document.getElementById("toggleViewBtn").addEventListener("click", () => {
        const resultsDiv = document.getElementById("results");
        if (viewMode === "card") {
          viewMode = "list";
          resultsDiv.classList.add("list-view");
          document.getElementById("toggleViewBtn").textContent = "卡片模式";
        } else {
          viewMode = "card";
          resultsDiv.classList.remove("list-view");
          document.getElementById("toggleViewBtn").textContent = "顯示清單";
        }
        updateResults();
      });
    }

    function populateCityOptions(region) {
      const citySelect = document.getElementById("citySelect");
      citySelect.innerHTML = "<option value=''>全部縣市</option>";
      if (region && citiesByRegion[region]) {
        Array.from(citiesByRegion[region]).sort((a, b) => a.localeCompare(b)).forEach(city => {
          const opt = document.createElement("option");
          opt.value = city;
          opt.textContent = city;
          citySelect.appendChild(opt);
        });
      } else {
        allCities.forEach(city => {
          const opt = document.createElement("option");
          opt.value = city;
          opt.textContent = city;
          citySelect.appendChild(opt);
        });
      }
    }

    function updateResults() {
      const regionValue = document.getElementById("regionSelect").value;
      const cityValue = document.getElementById("citySelect").value;
      const categoryValue = document.getElementById("categorySelect").value;
      const keywordValue = (document.getElementById("keywordInput").value || "").trim().toLowerCase();
      const requiredIndicators = Array.from(document.querySelectorAll(".indicator-chk:checked")).map(chk => chk.getAttribute("data-key"));
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      let count = 0;
      facilities.forEach(item => {
        if (regionValue && item.region != regionValue) return;
        if (cityValue && item.city != cityValue) return;
        if (categoryValue && item.category != categoryValue) return;

        if (keywordValue) {
          const text = ((item.name || "") + " " + (item.city || "") + " " + (item.category || "")).toLowerCase();
          if (!text.includes(keywordValue)) return;
        }

        for (const key of requiredIndicators) {
          if (!item.indicators || !item.indicators[key]) return;
        }

        const resultItem = document.createElement("div");
        resultItem.className = "result-item";

        if (viewMode === "card") {
          const nameEl = document.createElement("h3");
          nameEl.className = "facility-name";
          nameEl.textContent = item.name || "(未命名)";
          if (item.floor) {
            const floorSmall = document.createElement("small");
            floorSmall.textContent = " " + item.floor;
            nameEl.appendChild(document.createTextNode(" "));
            nameEl.appendChild(floorSmall);
          }
          resultItem.appendChild(nameEl);

          const locEl = document.createElement("p");
          locEl.className = "location-category";
          locEl.textContent = (item.region || "-") + " / " + (item.city || "-") + "，類別：" + (item.category || "-");
          resultItem.appendChild(locEl);

          const featuresEl = document.createElement("p");
          featuresEl.className = "features";
          const feats = [];
          if (item.indicators?.stroller) feats.push("嬰兒車租借");
          if (item.indicators?.nursing) feats.push("哺乳室");
          if (item.indicators?.diaper) feats.push("尿布檯");
          if (item.indicators?.hotwater) feats.push("熱水提供");
          if (item.indicators?.elevator) feats.push("電梯");
          if (item.indicators?.queue) feats.push("排隊禮遇");
          if (item.indicators?.play) feats.push("遊戲區");
          featuresEl.textContent = feats.length ? ("提供：" + feats.join("、 ")) : "無特殊設施";
          resultItem.appendChild(featuresEl);

          const sourceEl = document.createElement("p");
          sourceEl.className = "source-link";
          sourceEl.textContent = "資料來源：";
          if (item.source) {
            const link = document.createElement("a");
            link.href = item.source;
            link.textContent = "詳情";
            link.target = "_blank";
            link.rel = "noopener";
            sourceEl.appendChild(link);
          } else {
            const span = document.createElement("span");
            span.textContent = "(無)";
            sourceEl.appendChild(span);
          }
          resultItem.appendChild(sourceEl);
        } else {
          const nameEl = document.createElement("span");
          nameEl.className = "facility-name";
          nameEl.textContent = item.name || "(未命名)";
          resultItem.appendChild(nameEl);

          const locCatEl = document.createElement("span");
          locCatEl.className = "location-category";
          locCatEl.textContent = (item.region || "-") + "/" + (item.city || "-") + " " + (item.category || "-");
          resultItem.appendChild(locCatEl);

          const featEl = document.createElement("span");
          featEl.className = "features";
          const feats = [];
          if (item.indicators?.stroller) feats.push("嬰兒車租借");
          if (item.indicators?.nursing) feats.push("哺乳室");
          if (item.indicators?.diaper) feats.push("尿布檯");
          if (item.indicators?.hotwater) feats.push("熱水提供");
          if (item.indicators?.elevator) feats.push("電梯");
          if (item.indicators?.queue) feats.push("排隊禮遇");
          if (item.indicators?.play) feats.push("遊戲區");
          featEl.textContent = feats.length ? feats.join("、 ") : "無特殊設施";
          resultItem.appendChild(featEl);

          const srcEl = document.createElement("span");
          srcEl.className = "source-link";
          if (item.source) {
            const link = document.createElement("a");
            link.href = item.source;
            link.textContent = "詳情";
            link.target = "_blank";
            link.rel = "noopener";
            srcEl.appendChild(link);
          } else {
            const span = document.createElement("span");
            span.textContent = "(無)";
            srcEl.appendChild(span);
          }
          resultItem.appendChild(srcEl);
        }

        resultsDiv.appendChild(resultItem);
        count++;
      });

      if (count === 0) {
        resultsDiv.textContent = "未找到符合條件的結果。";
      }
    }
  })();
  </script>
</body>
</html>
