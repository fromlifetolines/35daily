<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>嬰幼兒友善設施全覽</title>
  <style>
    :root{
      --bg:#f6f7f8; --card:#fff; --brand:#2b2f36; --accent:#4a90e2;
      --muted:#8a8f98; --border:#e6e8eb;
    }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue","PingFang TC","Microsoft JhengHei",Arial,sans-serif;background:var(--bg);margin:0;color:var(--brand);line-height:1.5}
    header{background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
    .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
    .title{font-size:20px;font-weight:700;margin:0}
    .filters{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:10px}
    .filters select,.filters input{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer;font-size:14px}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .pillset{display:flex;flex-wrap:wrap;gap:6px;grid-column:1 / -1}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:13px;background:#fff}
    .muted{color:var(--muted);font-size:12px}
    table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-top:10px}
    thead th{background:#fafbfc;font-weight:600;font-size:13px;padding:10px;border-bottom:1px solid var(--border);position:sticky;top:92px;z-index:5}
    tbody td{border-top:1px solid var(--border);font-size:13px;padding:10px;text-align:center}
    tbody tr:nth-child(even) td{background:#fcfcfd}
    .tag{background:#f1f3f5;border:1px solid var(--border);padding:1px 6px;border-radius:999px;font-size:12px}
    .ok{color:#0f7b0f;font-weight:700}.no{color:#999}.score{font-weight:700}
    .empty{padding:20px;text-align:center;color:var(--muted)}
    /* 行動清單抽屜 */
    .drawer{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:30}
    .drawer.active{display:block}
    .drawer .panel{position:absolute;bottom:0;left:0;right:0;background:#fff;border-radius:16px 16px 0 0;max-height:85vh;overflow:auto;padding:12px 12px 20px}
    .list-card{border:1px solid var(--border);border-radius:12px;padding:10px;margin:8px 0}
    .list-title{margin:0 0 6px;font-weight:600}
    .badges span{display:inline-block;background:#f1f3f5;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;margin-right:6px;margin-bottom:6px}
    .badge-yes{border-color:#cce5cc;background:#eef8ee;color:#0f7b0f}
    .badge-no{color:#888}
    @media (max-width:960px){.filters{grid-template-columns:1fr 1fr} thead th{top:140px}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <p class="title">嬰幼兒友善設施全覽</p>
    </div>
  </header>

  <main class="wrap">
    <section class="filters" aria-label="篩選條件">
      <select id="regionSelect" aria-label="選擇地區">
        <option value="">全部地區</option>
        <option>北部</option><option>中部</option><option>南部</option><option>東部</option><option>離島</option>
      </select>
      <select id="citySelect" aria-label="選擇縣市">
        <option value="">全部縣市</option>
        <option>台北市</option><option>新北市</option><option>基隆市</option><option>桃園市</option>
        <option>新竹市</option><option>新竹縣</option><option>苗栗縣</option>
        <option>台中市</option><option>彰化縣</option><option>南投縣</option><option>雲林縣</option>
        <option>嘉義市</option><option>嘉義縣</option><option>台南市</option><option>高雄市</option><option>屏東縣</option>
        <option>宜蘭縣</option><option>花蓮縣</option><option>台東縣</option>
        <option>金門縣</option><option>澎湖縣</option><option>連江縣</option>
      </select>
      <select id="categorySelect" aria-label="選擇類別">
        <option value="">全部類別</option>
        <option>百貨公司</option><option>購物中心/Outlet</option><option>賣場/超市</option>
        <option>捷運</option><option>機場</option><option>機場捷運</option><option>高鐵</option>
        <option>景點</option><option>飯店</option><option>城市公共設施</option><option>公園/圖書館/親子館</option>
      </select>
      <input id="keywordInput" type="text" placeholder="輸入關鍵字（場所/樓層/特色…）" />
      <div class="actions">
        <button id="resetBtn" class="btn" title="清除所有篩選條件">清除</button>
        <button id="showListBtn" class="btn primary">顯示清單</button>
      </div>
      <div class="pillset" aria-label="設施指標篩選">
        <label class="pill"><input type="checkbox" data-k="stroller" /> 推車友善</label>
        <label class="pill"><input type="checkbox" data-k="nursing" /> 哺乳室</label>
        <label class="pill"><input type="checkbox" data-k="diaper" /> 尿布台</label>
        <label class="pill"><input type="checkbox" data-k="hotwater" /> 微波/熱水</label>
        <label class="pill"><input type="checkbox" data-k="elevator" /> 電梯/斜坡</label>
        <label class="pill"><input type="checkbox" data-k="queue" /> 親子候位</label>
        <label class="pill"><input type="checkbox" data-k="play" /> 免費親子遊戲區</label>
      </div>
    </section>

    <p class="muted" id="countNote">資料筆數：—</p>

    <section aria-label="資料表格">
      <table id="table">
        <thead>
          <tr>
            <th>地區</th><th>縣市</th><th>類別</th><th>場所</th>
            <th>樓層/位置</th><th>設施（✓ 代表提供）</th><th>綜合評分</th><th>來源</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="emptyHint" class="empty" style="display:none;">沒有符合的結果，請調整篩選條件或清除全部。</div>
    </section>

    <footer class="muted" style="margin:24px 0 80px;">資料以官方公告與現場標示為準；若有更新歡迎回報。</footer>
  </main>

  <!-- 行動清單抽屜 -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <strong>目前篩選結果清單</strong>
        <button id="closeDrawer" class="btn">關閉</button>
      </div>
      <div id="listContainer"></div>
    </div>
  </div>

<script>
/* ---- 資料與評分 ---- */
const IND_KEYS=["stroller","nursing","diaper","hotwater","elevator","queue","play"];
function calcScore(item){const t=IND_KEYS.reduce((a,k)=>a+(item.indicators?.[k]?1:0),0);return Math.round((t/IND_KEYS.length)*50)/10;}
function cellYN(v){return v?'<span class="ok">✓</span>':'<span class="no">—</span>';}

/* ---- 狀態 ---- */
const state={data:[],filters:{}};

/* ---- 載入資料（含防呆）---- */
async function loadData(){
  try{
    const res=await fetch('data/facilities.json?ts='+Date.now());
    if(!res.ok) throw new Error('HTTP '+res.status);
    state.data=await res.json();
    // 預設清空所有篩選，避免首次載入 0 筆
    resetAll(true);
    render();
  }catch(err){
    console.error('資料載入失敗：',err);
    document.getElementById('countNote').textContent='資料載入失敗，請確認 data/facilities.json 是否放在 /data/ 資料夾。';
  }
}

/* ---- 取得與套用篩選 ---- */
function getFilters(){
  const map={}; document.querySelectorAll('.pillset input[type="checkbox"]').forEach(cb=>map[cb.dataset.k]=cb.checked);
  state.filters={
    region:document.getElementById('regionSelect').value.trim(),
    city:document.getElementById('citySelect').value.trim(),
    category:document.getElementById('categorySelect').value.trim(),
    keyword:document.getElementById('keywordInput').value.trim().toLowerCase(),
    indicators:map
  };
}
function matches(item){
  const f=state.filters;
  if(f.region && item.region!==f.region) return false;
  if(f.city && item.city!==f.city) return false;
  if(f.category && item.category!==f.category) return false;
  if(f.keyword){
    const txt=(item.name+' '+(item.floor||'')+' '+(item.city||'')+' '+(item.category||'')).toLowerCase();
    if(!txt.includes(f.keyword)) return false;
  }
  for(const k in f.indicators){ if(f.indicators[k] && !item.indicators?.[k]) return false; }
  return true;
}
function currentFiltered(){ getFilters(); return state.data.filter(matches); }

/* ---- 渲染 ---- */
function render(){
  const tbody=document.querySelector('#table tbody');
  const empty=document.getElementById('emptyHint');
  tbody.innerHTML='';
  const filtered=currentFiltered();
  document.getElementById('countNote').textContent='資料筆數：'+filtered.length;
  empty.style.display= filtered.length? 'none':'block';
  filtered.forEach(item=>{
    const tr=document.createElement('tr');
    const score=calcScore(item).toFixed(1);
    tr.innerHTML=`
      <td>${item.region}</td><td>${item.city}</td><td><span class="tag">${item.category}</span></td>
      <td>${item.name}</td><td>${item.floor||'—'}</td>
      <td style="white-space:nowrap;">${IND_KEYS.map(k=>cellYN(item.indicators?.[k])).join(' ')}</td>
      <td class="score">${score}</td>
      <td>${item.source?`<a href="${item.source}" target="_blank" rel="noopener">來源</a>`:'—'}</td>`;
    tbody.appendChild(tr);
  });
}

/* ---- 互動 ---- */
['regionSelect','citySelect','categorySelect','keywordInput'].forEach(id=>document.getElementById(id).addEventListener('input',render));
document.querySelectorAll('.pillset input[type="checkbox"]').forEach(cb=>cb.addEventListener('change',render));

function resetAll(silent){
  document.getElementById('regionSelect').value='';
  document.getElementById('citySelect').value='';
  document.getElementById('categorySelect').value='';
  document.getElementById('keywordInput').value='';
  document.querySelectorAll('.pillset input[type="checkbox"]').forEach(cb=>cb.checked=false);
  if(!silent) render();
}
document.getElementById('resetBtn').addEventListener('click',()=>resetAll());

/* ---- 行動清單 ---- */
const drawer=document.getElementById('drawer');
document.getElementById('showListBtn').addEventListener('click',()=>{drawer.classList.add('active');renderList();});
document.getElementById('closeDrawer').addEventListener('click',()=>drawer.classList.remove('active'));
drawer.addEventListener('click',e=>{if(e.target===drawer) drawer.classList.remove('active');});
function renderList(){
  const list=document.getElementById('listContainer');
  const filtered=currentFiltered();
  if(!filtered.length){ list.innerHTML='<div class="empty">目前沒有符合的結果。</div>'; return; }
  list.innerHTML=filtered.map(item=>{
    const ys=IND_KEYS.map(k=>item.indicators?.[k]); const score=calcScore(item).toFixed(1);
    return `
      <div class="list-card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h4 class="list-title">${item.name}</h4>
          <span class="tag">${item.category}</span>
        </div>
        <div class="muted">${item.region}・${item.city}・樓層：${item.floor||'—'}・評分：<strong>${score}</strong></div>
        <div class="badges" style="margin-top:6px;">
          <span class="${ys[0]?'badge-yes':'badge-no'}">推車</span>
          <span class="${ys[1]?'badge-yes':'badge-no'}">哺乳室</span>
          <span class="${ys[2]?'badge-yes':'badge-no'}">尿布台</span>
          <span class="${ys[3]?'badge-yes':'badge-no'}">熱水</span>
          <span class="${ys[4]?'badge-yes':'badge-no'}">電梯/斜坡</span>
          <span class="${ys[5]?'badge-yes':'badge-no'}">親子候位</span>
          <span class="${ys[6]?'badge-yes':'badge-no'}">遊戲區</span>
        </div>
        <div style="margin-top:8px;">${item.source?`<a href="${item.source}" target="_blank" rel="noopener">查看來源</a>`:'&nbsp;'}</div>
      </div>`;
  }).join('');
}

/* ---- 啟動 ---- */
loadData();
</script>
</body>
</html>
